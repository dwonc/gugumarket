<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${product.title} + ' - GUGU Market'">ìƒí’ˆ ìƒì„¸ - GUGU Market</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <style>
        /* ìƒì„¸ í˜ì´ì§€ ì „ìš© í‘¸í„° ë³´ì • */
        footer.bg-primary {
            grid-column: 1 / -1;
            margin-left: 0;
            margin-right: 0;
        }
    </style>


    <style>
        :root {
            --primary: #6B4F4F;
            --secondary: #8B7070;
            --accent: #A89080;
            --light: #E8D5D5;
        }
        .bg-primary { background-color: var(--primary); }
        .bg-secondary { background-color: var(--secondary); }
        .text-primary { color: var(--primary); }
        .border-primary { border-color: var(--primary); }
        .hover\:bg-primary:hover { background-color: var(--primary); }
        .hover\:bg-secondary:hover { background-color: var(--secondary); }
        .hover\:text-primary:hover { color: var(--primary); }
    </style>
</head>
<body class="bg-gray-50">
<div class="bg-primary text-white py-2">
    <div class="max-w-7xl mx-auto px-4">
        <div class="flex justify-end items-center space-x-6 text-sm">

            <!-- âœ… ë¡œê·¸ì¸ ìƒíƒœ -->
            <span th:if="${#authorization.expression('isAuthenticated()')}"
                  th:text="${#authentication.name} + 'ë‹˜'">ì‚¬ìš©ìë‹˜</span>

            <form th:if="${#authorization.expression('isAuthenticated()')}"
                  th:action="@{/users/logout}" method="post" class="inline">
                <button type="submit" class="hover:underline bg-transparent border-0 text-white">ë¡œê·¸ì•„ì›ƒ</button>
            </form>

            <!-- âœ… ë¹„ë¡œê·¸ì¸ ìƒíƒœ -->
            <a th:if="${#authorization.expression('isAnonymous()')}"
               href="/users/login"
               class="hover:underline">ë¡œê·¸ì¸</a>

            <a th:if="${#authorization.expression('isAnonymous()')}"
               href="/users/signup"
               class="hover:underline">íšŒì›ê°€ì…</a>
        </div>
    </div>
</div>

<!-- Navbar -->
<nav class="bg-white shadow-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-20">
            <a href="/main" class="flex items-center space-x-3">
                <i class="bi bi-shop text-4xl text-primary"></i>
                <span class="text-3xl font-bold text-primary">GUGU Market</span>
            </a>
        </div>
    </div>
</nav>

<!-- Breadcrumb -->
<div class="bg-white border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex items-center space-x-2 text-sm text-gray-600">
            <!-- í™ˆ ë§í¬ -->
            <a href="/" class="hover:text-primary">
                <i class="bi bi-house-door"></i> í™ˆ
            </a>
            <i class="bi bi-chevron-right text-xs"></i>

            <!-- ì¹´í…Œê³ ë¦¬ ë§í¬ (â­ ìˆ˜ì •ë¨) -->
            <a th:if="${product.category != null}"
               th:href="@{/main(categoryId=${product.category.categoryId})}"
               class="hover:text-primary transition-colors duration-200"
               th:text="${product.category.name}">
                ë°˜ë ¤ë™ë¬¼ìš©í’ˆ
            </a>
            <span th:unless="${product.category != null}" class="text-gray-400">ë¯¸ë¶„ë¥˜</span>

            <i class="bi bi-chevron-right text-xs"></i>

            <!-- í˜„ì¬ ìƒí’ˆëª… -->
            <span class="text-gray-800 font-medium" th:text="${product.title}">ìº í•‘ í…íŠ¸ 4ì¸ìš©</span>
        </div>
    </div>
</div>

<!-- Product Detail -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Left: Product Images -->
        <div class="space-y-4">
            <!-- Main Image -->
            <div class="bg-white rounded-2xl overflow-hidden shadow-lg">
                <img
                        id="mainImage"
                        th:src="${product.mainImage}"
                        th:alt="${product.title}"
                        class="w-full h-96 object-cover"
                        onerror="this.src='https://via.placeholder.com/600x400/6B4F4F/FFFFFF?text=No+Image'"
                />
            </div>

            <!-- Thumbnail Images -->
            <div class="grid grid-cols-4 gap-3" th:if="${product.productImages != null && !product.productImages.isEmpty()}">
                <div th:each="image : ${product.productImages}"
                     class="bg-white rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-primary transition-all">
                    <img
                            th:src="${image.imageUrl}"
                            th:alt="'ìƒí’ˆ ì´ë¯¸ì§€ ' + ${image.imageOrder}"
                            class="w-full h-24 object-cover"
                            onclick="changeMainImage(this.src)"
                    />
                </div>
            </div>

        <!-- Right: Product Info -->
        <div class="space-y-6">
            <div class="bg-white rounded-2xl shadow-lg p-8">
                <!-- Title -->
                <h1 class="text-3xl font-bold text-gray-800 mb-4" th:text="${product.title}">ìƒí’ˆëª…</h1>

                <!-- Price -->
                <div class="mb-6">
                        <span class="text-4xl font-bold text-primary">
                            <span th:text="${#numbers.formatInteger(product.price, 0, 'COMMA')}">0</span>ì›
                        </span>
                </div>

                <!-- Product Meta Info -->
                <div class="space-y-3 py-6 border-y border-gray-200">
                    <div class="flex justify-between">
                        <span class="text-gray-600">ì¹´í…Œê³ ë¦¬</span>
                        <span class="font-medium" th:text="${product.category.name}">ì „ìê¸°ê¸°</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">ìƒíƒœ</span>
                        <span class="font-medium">ì¤‘ê³ </span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">íŒë§¤ì</span>
                        <span class="font-medium" th:text="${product.seller.nickname}">íŒë§¤ìëª…</span>
                    </div>
                    <div class="flex justify-between" th:if="${product.seller.address != null}">
                        <span class="text-gray-600">ê±°ë˜ì§€ì—­</span>
                        <span class="font-medium" th:text="${product.seller.address}">ì„œìš¸ ê°•ë‚¨êµ¬</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">ì¡°íšŒìˆ˜</span>
                        <span class="font-medium" th:text="${product.viewCount}">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">ë“±ë¡ì¼</span>
                        <span class="font-medium" th:text="${#temporals.format(product.createdDate, 'yyyy-MM-dd')}">2025-01-01</span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="mt-6">
                    <!-- ğŸ”¥ íŒë§¤ìì¸ ê²½ìš° (ìˆ˜ì •ë¨!) -->
                    <div th:if="${#authentication.principal != null and #authentication.name == product.seller.userName}">

                        <!-- ìƒíƒœ ë³€ê²½ UI -->
                        <div class="mb-4 p-4 bg-gray-50 rounded-lg border-2 border-gray-200">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-700 font-medium">ìƒí’ˆ ìƒíƒœ</span>
                                <select
                                        id="statusSelect"
                                        th:data-product-id="${product.productId}"
                                        class="border-2 border-primary rounded-lg px-4 py-2 font-medium">
                                    <option value="SALE" th:selected="${product.status.name() == 'SALE'}">ğŸŸ¢ íŒë§¤ì¤‘</option>
                                    <option value="RESERVED" th:selected="${product.status.name() == 'RESERVED'}">ğŸŸ¡ ì˜ˆì•½ì¤‘</option>
                                    <option value="SOLD_OUT" th:selected="${product.status.name() == 'SOLD_OUT'}">ğŸ”´ íŒë§¤ì™„ë£Œ</option>
                                </select>
                            </div>
                        </div>

                        <button
                                onclick="saveStatus()"
                                class="w-full bg-primary hover:bg-secondary text-white font-bold py-4 rounded-lg transition-all mb-3">
                            <i class="bi bi-check-circle text-xl mr-2"></i>ìƒíƒœ ë³€ê²½ ì €ì¥
                        </button>

                        <!-- ğŸ”¥ êµ¬ë§¤ í¬ë§ì ëª©ë¡ -->
                        <div class="p-4 bg-blue-50 rounded-lg border-2 border-blue-200" th:if="${interestedBuyers != null}">
                            <h3 class="font-bold text-gray-800 mb-3 flex items-center justify-between">
                                    <span>
                                        <i class="bi bi-people-fill mr-2"></i>êµ¬ë§¤ í¬ë§ì ëª©ë¡
                                    </span>
                                <span class="text-sm text-blue-600" th:text="'ì´ ' + ${interestedBuyers.size()} + 'ëª…'">ì´ 0ëª…</span>
                            </h3>

                            <div class="space-y-2 max-h-64 overflow-y-auto" th:if="${!interestedBuyers.empty}">
                                <div th:each="buyer : ${interestedBuyers}"
                                     class="flex items-center justify-between bg-white p-3 rounded-lg hover:shadow-md transition-all">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-gradient-to-br from-primary to-secondary rounded-full flex items-center justify-center">
                                            <i class="bi bi-person text-white"></i>
                                        </div>
                                        <div>
                                            <p class="font-semibold" th:text="${buyer.nickname}">êµ¬ë§¤ìëª…</p>
                                            <p class="text-sm text-gray-500" th:if="${buyer.address != null}">
                                                <i class="bi bi-geo-alt"></i>
                                                <span th:text="${buyer.address}">ì£¼ì†Œ</span>
                                            </p>
                                        </div>
                                    </div>
                                    <form th:action="@{/product/{id}/complete(id=${product.productId})}"
                                          method="post"
                                          onsubmit="return confirm('ì´ ì‚¬ìš©ìì™€ ê±°ë˜ë¥¼ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê±°ë˜ ì™„ë£Œ í›„ì—ëŠ” ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');">
                                        <input type="hidden" name="buyerId" th:value="${buyer.userId}">
                                        <button
                                                type="submit"
                                                class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-all flex items-center gap-2"
                                                th:disabled="${product.status.name() == 'SOLD_OUT'}">
                                            <i class="bi bi-check-circle"></i>
                                            ê±°ë˜ì™„ë£Œ
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <div th:if="${interestedBuyers.empty}"
                                 class="text-center py-8 text-gray-500">
                                <i class="bi bi-inbox text-4xl mb-2"></i>
                                <p>ì•„ì§ ì°œí•œ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                                <p class="text-sm mt-1">ìƒí’ˆì„ ì°œí•œ ì‚¬ìš©ìê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                            </div>
                        </div>

                        <!-- ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ -->
                        <div class="flex gap-3 mt-3">
                            <button
                                    th:onclick="|location.href='/product/${product.productId}/edit'|"
                                    class="flex-1 bg-white border-2 border-primary text-primary hover:bg-primary hover:text-white font-bold py-3 rounded-lg transition-all">
                                <i class="bi bi-pencil mr-1"></i>ìˆ˜ì •
                            </button>
                            <button
                                    onclick="deleteProduct()"
                                    class="flex-1 bg-white border-2 border-red-500 text-red-500 hover:bg-red-500 hover:text-white font-bold py-3 rounded-lg transition-all">
                                <i class="bi bi-trash mr-1"></i>ì‚­ì œ
                            </button>
                        </div>
                    </div>

                    <!-- ğŸ”¥ ì¼ë°˜ ì‚¬ìš©ìì¸ ê²½ìš° (ìˆ˜ì •ë¨!) -->
                    <div th:if="${#authentication.principal == null or #authentication.name != product.seller.userName}">
                        <!-- íŒë§¤ì™„ë£Œ/ì˜ˆì•½ì¤‘ í‘œì‹œ -->
                        <div th:if="${product.status.name() == 'SOLD_OUT'}" class="mb-4 p-4 bg-red-50 border-2 border-red-200 rounded-lg text-center">
                            <p class="text-red-700 font-bold text-lg">ğŸ”´ íŒë§¤ì™„ë£Œëœ ìƒí’ˆì…ë‹ˆë‹¤</p>
                        </div>

                        <div th:if="${product.status.name() == 'RESERVED'}" class="mb-4 p-4 bg-yellow-50 border-2 border-yellow-200 rounded-lg text-center">
                            <p class="text-yellow-700 font-bold text-lg">ğŸŸ¡ ì˜ˆì•½ì¤‘ì¸ ìƒí’ˆì…ë‹ˆë‹¤</p>
                        </div>

                        <div class="flex gap-3">
                            <!-- ğŸ”¥ ì°œí•˜ê¸° ë²„íŠ¼ -->
                            <button
                                    id="likeButton"
                                    onclick="toggleLike()"
                                    th:classappend="${isLiked} ? 'bg-red-500 text-white border-red-500' : 'bg-white text-primary border-primary hover:bg-primary hover:text-white'"
                                    class="flex-1 border-2 font-bold py-4 rounded-lg transition-all duration-300 flex items-center justify-center gap-2"
                                    th:disabled="${product.status.name() == 'SOLD_OUT'}">
                                <i th:class="${isLiked} ? 'bi bi-heart-fill' : 'bi bi-heart'" class="text-xl"></i>
                                <span id="likeText" th:text="${isLiked} ? 'ì°œ ì·¨ì†Œ' : 'ì°œí•˜ê¸°'">ì°œí•˜ê¸°</span>
                                <span id="likeCount"
                                      class="ml-1 px-2 py-0.5 bg-black/10 rounded-full text-sm"
                                      th:text="${likeCount}">0</span>
                            </button>

                            <!-- êµ¬ë§¤í•˜ê¸° ë²„íŠ¼ -->
                            <button
                                    th:onclick="${product.status.name() == 'SOLD_OUT'} ? 'alert(\'íŒë§¤ì™„ë£Œëœ ìƒí’ˆì…ë‹ˆë‹¤.\')' : 'location.href=\'/purchase?productId=' + ${product.productId} + '\''"
                                    class="flex-1 bg-primary hover:bg-secondary text-white font-bold py-4 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-lg flex items-center justify-center gap-2"
                                    th:classappend="${product.status.name() == 'SOLD_OUT'} ? 'opacity-50 cursor-not-allowed bg-gray-400 hover:bg-gray-400' : ''"
                                    th:disabled="${product.status.name() == 'SOLD_OUT'}">
                                <i class="bi bi-cart text-xl"></i>
                                <span th:text="${product.status.name() == 'SOLD_OUT'} ? 'íŒë§¤ì™„ë£Œ' : 'êµ¬ë§¤í•˜ê¸°'">êµ¬ë§¤í•˜ê¸°</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Share & Report -->
                <div class="flex gap-3 mt-4">
                    <button class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 rounded-lg transition-all">
                        <i class="bi bi-share mr-2"></i>ê³µìœ í•˜ê¸°
                    </button>
                    <button class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 rounded-lg transition-all">
                        <i class="bi bi-flag mr-2"></i>ì‹ ê³ í•˜ê¸°
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Description -->
    <div class="mt-8 bg-white rounded-2xl shadow-lg p-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">ìƒí’ˆ ì„¤ëª…</h2>
        <div class="prose max-w-none text-gray-700 leading-relaxed whitespace-pre-line" th:text="${product.content}">
            ìƒí’ˆ ì„¤ëª… ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
        </div>
    </div>



        <!-- ëŒ“ê¸€ ì‹œì‘ -->
        <script th:inline="javascript">
            /* CSRF ë©”íƒ€ ìë™ ì£¼ì… */
            (function(){
                var token  = /*[[${_csrf.token}]]*/ '';
                var header = /*[[${_csrf.headerName}]]*/ 'X-CSRF-TOKEN';
                if (token && !document.querySelector('meta[name="_csrf"]')) {
                    var m1=document.createElement('meta'); m1.name='_csrf'; m1.content=token; document.head.appendChild(m1);
                    var m2=document.createElement('meta'); m2.name='_csrf_header'; m2.content=header; document.head.appendChild(m2);
                }
            })();

            /* ëŒ“ê¸€ ì„¹ì…˜ ì—†ìœ¼ë©´ ìë™ ìƒì„± */
            (function ensureCommentSection(){
                const hasForm = document.querySelector('form[action$="/comment"], form[th\\:action="@{/comment}"]');
                if (hasForm) return;

                const productId = /*[[${product.productId}]]*/ 0;
                const descBlock = Array.from(document.querySelectorAll('div.mt-8.bg-white.rounded-2xl.shadow-lg.p-8'))
                    .find(box => box.querySelector('h2') && box.querySelector('h2').textContent.includes('ìƒí’ˆ ì„¤ëª…'));
                const mountPoint = descBlock?.parentElement || document.querySelector('.max-w-7xl.mx-auto') || document.body;

                const wrapper = document.createElement('div');
                wrapper.className = 'mt-8 bg-white rounded-2xl shadow-lg p-8';
                wrapper.innerHTML = `
<h2 class="text-2xl font-bold text-gray-800 mb-6">ëŒ“ê¸€ <span class="text-primary">0</span></h2>
<form action="/comment" method="post" class="mb-8">
  <input type="hidden" name="productId" value="${productId}" />
  <textarea name="content" rows="3"
    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-primary resize-none"
    placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." required></textarea>
  <div class="flex justify-end mt-3">
    <button type="submit"
      class="bg-primary hover:bg-secondary text-white font-medium px-6 py-2 rounded-lg transition-all">
      ëŒ“ê¸€ ì‘ì„±
    </button>
  </div>
</form>
<div class="space-y-4"></div>
`;
                if (descBlock) descBlock.insertAdjacentElement('afterend', wrapper);
                else mountPoint.appendChild(wrapper);
            })();

            /* ëŒ“ê¸€ ë³¸ì²´: ëª©ë¡/ì‘ì„±/ìˆ˜ì •/ì‚­ì œ + âœ…ëŒ€ëŒ“ê¸€(ì•„ë˜ 'ë‹µê¸€' ë²„íŠ¼) */
            (function () {
                const getMeta = (n)=>document.querySelector(`meta[name="${n}"]`)?.getAttribute('content')||'';
                const CSRF_TOKEN  = getMeta('_csrf');
                const CSRF_HEADER = getMeta('_csrf_header')||'X-CSRF-TOKEN';

                const $  = (s,r=document)=>r.querySelector(s);
                const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));

                // í¼ submit ê°€ë¡œì±„ê¸°(ìµœìƒìœ„ ëŒ“ê¸€)
                document.addEventListener('submit',(e)=>{
                    const f=e.target;
                    const action=(f.getAttribute('action')||f.getAttribute('th:action')||'')+'';
                    if(action.endsWith('/comment')){ e.preventDefault(); handleSubmit(f); }
                },true);

                const commentForm = document.querySelector('form[action$="/comment"]') ||
                    document.querySelector('form[th\\:action="@{/comment}"]');
                if(!commentForm) return;

                const productId  = (commentForm.querySelector('input[name="productId"]')||{}).value;
                const textarea   = commentForm.querySelector('textarea[name="content"]');
                const section    = commentForm.closest('div.mt-8.bg-white.rounded-2xl.shadow-lg.p-8');
                const listBox    = section ? $('.space-y-4', section) : null;
                const countEl    = section ? $('h2 span.text-primary', section) : null;

                // âœ… ìŠ¤íƒ€ì¼ (ë‹µê¸€ ë²„íŠ¼ë§Œ ìˆ˜ì •: í…Œë‘ë¦¬ ì œê±° + ì™¼ìª½ìœ¼ë¡œ ì‚´ì§ ì´ë™)
                const style=document.createElement('style');
                style.textContent=`
.gugu-pop{position:absolute;right:0;top:28px;background:#fff;border:1px solid rgba(0,0,0,.1);
  border-radius:.5rem;box-shadow:0 10px 25px rgba(0,0,0,.08);overflow:hidden;z-index:60}
.gugu-pop button{display:block;width:120px;padding:10px 12px;text-align:left;font-size:14px}
.gugu-pop button:hover{background:rgba(0,0,0,.04)}
.gugu-item:hover .gugu-dots{color:#111827}
.gugu-edit,.gugu-reply{border:2px solid #e5e7eb;border-radius:.75rem;padding:.5rem;margin-top:.5rem;display:none}
.gugu-edit.show,.gugu-reply.show{display:block}
.gugu-children{margin-left:3rem;margin-top:.5rem}

/* â† ì—¬ê¸°ë§Œ ë°”ë€œ: ë‹µê¸€ ë²„íŠ¼ ìœ„ì¹˜ì™€ ëª¨ì–‘ */
.gugu-actions{
  margin-left:0;       /* â† ë“¤ì—¬ì“°ê¸° ì œê±° */
  margin-top:0.25rem;  /* ì•½ê°„ì˜ ìœ„ ì—¬ë°±ë§Œ */
}
.gugu-btn{
  display:inline-flex;align-items:center;gap:.375rem;
  border:0;background:transparent;padding:0;
  color:#6b7280;font-size:.875rem;line-height:1;cursor:pointer
}
.gugu-btn:hover{color:#374151}
`;
                document.head.appendChild(style);

                function jfetch(url,opt={}){
                    opt.headers=Object.assign({'Accept':'application/json','X-Requested-With':'XMLHttpRequest'},opt.headers||{});
                    const m=(opt.method||'GET').toUpperCase();
                    if(['POST','PUT','DELETE','PATCH'].includes(m)){
                        if(CSRF_TOKEN) opt.headers[CSRF_HEADER]=CSRF_TOKEN;
                        if(!opt.headers['Content-Type'] && !(opt.body instanceof FormData)){
                            opt.headers['Content-Type']='application/json';
                        }
                    }
                    return fetch(url,opt);
                }

                // ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
                async function fetchListSafe(){
                    try{
                        const res = await jfetch(`/api/products/${productId}/comments`);
                        if(!res.ok) return;
                        const data = await res.json().catch(()=>null);
                        if(!data || data.success===false || !Array.isArray(data.comments)) return;
                        renderTree(data.comments);
                        if(countEl) countEl.textContent = (data.count ?? data.comments.length);
                    }catch(err){
                        console.error('[ëŒ“ê¸€] ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:',err);
                    }
                }

                // ìµœìƒìœ„ ëŒ“ê¸€ ë“±ë¡
                async function handleSubmit(){
                    const content = textarea.value.trim();
                    if(!content) return alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
                    try{
                        const res = await jfetch(`/api/products/${productId}/comments`,{
                            method:'POST', body:JSON.stringify({content})
                        });
                        const data = await res.json();
                        if(data.needLogin){
                            if(confirm('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í• ê¹Œìš”?')) location.href='/users/login';
                            return;
                        }
                        if(!data.success) return alert(data.message||'ë“±ë¡ ì‹¤íŒ¨');
                        textarea.value='';
                        const it = createItem(data.comment);
                        listBox.appendChild(it);
                        if(countEl) countEl.textContent = (data.count ?? (parseInt(countEl.textContent||'0',10)+1));
                    }catch(err){
                        console.error('[ëŒ“ê¸€] ë“±ë¡ ì‹¤íŒ¨:',err);
                        alert('ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                }

                const esc = s => String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

                function createItem(c){
                    const wrap=document.createElement('div');
                    wrap.className="border-b border-gray-200 pb-4 last:border-b-0 gugu-item";
                    wrap.dataset.id=c.id;

                    // ìì‹ ì»¨í…Œì´ë„ˆ
                    const childrenWrap=document.createElement('div');
                    childrenWrap.className='gugu-children';

                    wrap.innerHTML=`
<div class="flex items-start justify-between mb-2 relative">
  <div class="flex items-center gap-3">
    <div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center">
      <i class="bi bi-person text-gray-600 text-xl"></i>
    </div>
    <div>
      <p class="font-semibold text-gray-800">${esc(c.userNickname??'ì‚¬ìš©ì')}</p>
      <p class="text-sm text-gray-500">${c.createdAt??''}</p>
    </div>
  </div>

  <!-- Â·Â·Â· ë©”ë‰´ (ìˆ˜ì •/ì‚­ì œ) -->
  <button class="text-gray-400 hover:text-gray-600 gugu-dots"><i class="bi bi-three-dots-vertical"></i></button>
  <div class="gugu-pop hidden">
    ${c.mine?`
      <button data-act="edit"><i class="bi bi-pencil"></i> ìˆ˜ì •</button>
      <button data-act="del" class="text-red-600"><i class="bi bi-trash"></i> ì‚­ì œ</button>
    `:`<div class="px-3 py-2 text-sm text-gray-500 select-none">ì‘ì—… ì—†ìŒ</div>`}
  </div>
</div>

<!-- ë³¸ë¬¸ -->
<p class="text-gray-700 ml-13 whitespace-pre-line gugu-content">${esc(c.content??'')}</p>

<!-- í•˜ë‹¨ ë™ì‘ì˜ì—­: âœ… í•­ìƒ ë³´ì´ëŠ” "ë‹µê¸€" ë²„íŠ¼ (í…Œë‘ë¦¬ ì—†ìŒ, ì™¼ìª½ìœ¼ë¡œ ì‚´ì§) -->
<div class="gugu-actions">
  <button type="button" class="gugu-btn" data-act="reply-open">
    <i class="bi bi-reply"></i><span>ë‹µê¸€</span>
  </button>
</div>

<!-- ìˆ˜ì • í¼ -->
<div class="gugu-edit">
  <textarea class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 focus:outline-none focus:border-primary resize-none" rows="3">${esc(c.content??'')}</textarea>
  <div class="flex justify-end gap-2 mt-2">
    <button class="px-4 py-2 rounded-lg border-2 border-gray-300" data-edit-cancel>ì·¨ì†Œ</button>
    <button class="px-4 py-2 rounded-lg bg-primary text-white" data-edit-save>ìˆ˜ì •</button>
  </div>
</div>

<!-- âœ… ë‹µê¸€ í¼ -->
<div class="gugu-reply">
  <textarea class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 focus:outline-none focus:border-primary resize-none" rows="3" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
  <div class="flex justify-end gap-2 mt-2">
    <button class="px-4 py-2 rounded-lg border-2 border-gray-300" data-reply-cancel>ì·¨ì†Œ</button>
    <button class="px-4 py-2 rounded-lg bg-primary text-white" data-reply-save>ë‹µê¸€ ë“±ë¡</button>
  </div>
</div>
`;
                    wrap.appendChild(childrenWrap);

                    // ë©”ë‰´ ì—´ê¸°/ë‹«ê¸°
                    const dots=$('.gugu-dots',wrap), pop=$('.gugu-pop',wrap);
                    dots?.addEventListener('click',(e)=>{e.stopPropagation(); pop.classList.toggle('hidden');});
                    document.addEventListener('click',()=>pop.classList.add('hidden'));

                    // ì‚­ì œ
                    $('[data-act="del"]',wrap)?.addEventListener('click',async()=>{
                        if(!confirm('ì´ ëŒ“ê¸€ì„ ì‚­ì œí• ê¹Œìš”?')) return;
                        try{
                            const res=await jfetch(`/api/comments/${c.id}`,{method:'DELETE'});
                            const data=await res.json();
                            if(data.success){
                                wrap.remove();
                                if(countEl) countEl.textContent=data.count;
                            }else if(data.needLogin){
                                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); location.href='/users/login';
                            }else{
                                alert(data.message||'ì‚­ì œ ì‹¤íŒ¨');
                            }
                        }catch(err){
                            console.error('[ëŒ“ê¸€] ì‚­ì œ ì‹¤íŒ¨:',err); alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        }
                    });

                    // ìˆ˜ì •
                    $('[data-act="edit"]',wrap)?.addEventListener('click',()=>$('.gugu-edit',wrap).classList.add('show'));
                    $('[data-edit-cancel]',wrap)?.addEventListener('click',()=>{
                        const box=$('.gugu-edit',wrap), ta=$('textarea',box);
                        ta.value=c.content??''; box.classList.remove('show');
                    });
                    $('[data-edit-save]',wrap)?.addEventListener('click',async()=>{
                        const box=$('.gugu-edit',wrap), ta=$('textarea',box);
                        const content=ta.value.trim(); if(!content) return alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
                        try{
                            const res=await jfetch(`/api/comments/${c.id}`,{method:'PUT',body:JSON.stringify({content})});
                            const data=await res.json();
                            if(data.success){
                                c.content=data.comment.content;
                                $('.gugu-content',wrap).textContent=c.content;
                                ta.value=c.content; box.classList.remove('show');
                            }else if(data.needLogin){
                                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); location.href='/users/login';
                            }else{
                                alert(data.message||'ìˆ˜ì • ì‹¤íŒ¨');
                            }
                        }catch(err){
                            console.error('[ëŒ“ê¸€] ìˆ˜ì • ì‹¤íŒ¨:',err); alert('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        }
                    });

                    // âœ… ë‹µê¸€ UI
                    $('[data-act="reply-open"]',wrap)?.addEventListener('click',()=>{
                        $('.gugu-reply',wrap).classList.add('show');
                        $('.gugu-edit',wrap)?.classList.remove('show'); // ì—´ë ¤ìˆë˜ ìˆ˜ì •í¼ ë‹«ê¸°
                    });
                    $('[data-reply-cancel]',wrap)?.addEventListener('click',()=>{
                        const box=$('.gugu-reply',wrap), ta=$('textarea',box);
                        ta.value=''; box.classList.remove('show');
                    });
                    $('[data-reply-save]',wrap)?.addEventListener('click',async()=>{
                        const box=$('.gugu-reply',wrap), ta=$('textarea',box);
                        const content=ta.value.trim(); if(!content) return alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
                        try{
                            const res=await jfetch(`/api/products/${productId}/comments`,{
                                method:'POST', body:JSON.stringify({content, parentId:String(c.id)})
                            });
                            const data=await res.json();
                            if(data.success){
                                const child=createItem(data.comment);
                                childrenWrap.appendChild(child);
                                ta.value=''; box.classList.remove('show');
                                if(countEl) countEl.textContent = (data.count ?? (parseInt(countEl.textContent||'0',10)+1));
                            }else if(data.needLogin){
                                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); location.href='/users/login';
                            }else{
                                alert(data.message||'ë“±ë¡ ì‹¤íŒ¨');
                            }
                        }catch(err){
                            console.error('[ëŒ“ê¸€] ë‹µê¸€ ë“±ë¡ ì‹¤íŒ¨:',err); alert('ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        }
                    });

                    // ì™¸ë¶€ì—ì„œ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ì°¸ì¡° ì €ì¥
                    wrap._childrenWrap = childrenWrap;
                    return wrap;
                }

                // í‰ë©´ â†’ íŠ¸ë¦¬ ë Œë”ë§
                function renderTree(items){
                    if(!listBox) return;
                    listBox.innerHTML='';

                    if(!items.length){
                        const empty=document.createElement('div');
                        empty.className='text-center py-8 text-gray-500';
                        empty.innerHTML=`<i class="bi bi-chat-dots text-4xl mb-2"></i><p>ì²« ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>`;
                        listBox.appendChild(empty); return;
                    }

                    const nodeMap=new Map();
                    items.forEach(c=>nodeMap.set(c.id, createItem(c)));
                    items.forEach(c=>{
                        const node=nodeMap.get(c.id);
                        if(c.parentId){
                            const p=nodeMap.get(c.parentId);
                            if(p && p._childrenWrap) p._childrenWrap.appendChild(node);
                            else listBox.appendChild(node);
                        }else{
                            listBox.appendChild(node);
                        }
                    });
                }

                fetchListSafe();
            })();
        </script>
        <!-- ëŒ“ê¸€ ë -->




        <!-- Footer -->

<footer class="bg-primary text-white mt-20 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <p>&copy; 2025 GUGU Market. All rights reserved.</p>
    </div>
</footer>



<script th:inline="javascript">
    // Change main image when clicking thumbnail
    function changeMainImage(src) {
        document.getElementById('mainImage').src = src;
    }

    // ğŸ”¥ ì°œí•˜ê¸° í† ê¸€
    async function toggleLike() {
        const productId = [[${product.productId}]];

        try {
            const response = await fetch(`/product/${productId}/like`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            const result = await response.json();

            // ë¡œê·¸ì¸ í•„ìš”
            if (result.needLogin) {
                if (confirm('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.\në¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    location.href = '/users/login';
                }
                return;
            }

            if (result.success) {
                const likeButton = document.getElementById('likeButton');
                const likeText = document.getElementById('likeText');
                const likeCount = document.getElementById('likeCount');
                const icon = likeButton.querySelector('i');

                if (result.isLiked) {
                    // ì°œí•˜ê¸° ì™„ë£Œ
                    likeButton.classList.remove('bg-white', 'text-primary', 'border-primary');
                    likeButton.classList.add('bg-red-500', 'text-white', 'border-red-500');
                    icon.classList.remove('bi-heart');
                    icon.classList.add('bi-heart-fill');
                    likeText.textContent = 'ì°œ ì·¨ì†Œ';
                } else {
                    // ì°œí•˜ê¸° ì·¨ì†Œ
                    likeButton.classList.remove('bg-red-500', 'text-white', 'border-red-500');
                    likeButton.classList.add('bg-white', 'text-primary', 'border-primary');
                    icon.classList.remove('bi-heart-fill');
                    icon.classList.add('bi-heart');
                    likeText.textContent = 'ì°œí•˜ê¸°';
                }

                likeCount.textContent = result.likeCount;
            } else {
                alert(result.message);
            }

        } catch (error) {
            console.error('Error:', error);
            alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ğŸ”¥ ìƒíƒœ ë³€ê²½ ì €ì¥
    let originalStatus = document.getElementById('statusSelect')?.value;

    async function saveStatus() {
        const selectElement = document.getElementById('statusSelect');
        const productId = selectElement.dataset.productId;
        const newStatus = selectElement.value;

        // ë³€ê²½ì‚¬í•­ì´ ì—†ìœ¼ë©´
        if (newStatus === originalStatus) {
            alert('ë³€ê²½ëœ ìƒíƒœê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        const statusText = selectElement.options[selectElement.selectedIndex].text;
        if (!confirm(`ìƒí’ˆ ìƒíƒœë¥¼ "${statusText}"(ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            selectElement.value = originalStatus;
            return;
        }

        try {
            const response = await fetch(`/product/${productId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: newStatus })
            });

            const result = await response.json();

            if (result.success) {
                alert('âœ… ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                originalStatus = newStatus;
                location.reload();
            } else {
                alert('âŒ ' + (result.message || 'ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
                selectElement.value = originalStatus;
            }
        } catch (error) {
            console.error('Error:', error);
            alert('âŒ ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            selectElement.value = originalStatus;
        }
    }

    // ğŸ”¥ ìƒí’ˆ ì‚­ì œ
    async function deleteProduct() {
        if (!confirm('ì •ë§ë¡œ ì´ ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ ìƒí’ˆì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
            return;
        }

        const productId = document.getElementById('statusSelect').dataset.productId;

        try {
            const response = await fetch(`/product/${productId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('âœ… ìƒí’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                location.href = '/mypage';
            } else {
                alert('âŒ ìƒí’ˆ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('âŒ ìƒí’ˆ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
</script>

</body>
</html>