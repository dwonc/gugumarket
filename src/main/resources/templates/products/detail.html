<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${product.title} + ' - GUGU Market'">상품 상세 - GUGU Market</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <style>
        /* 상세 페이지 전용 푸터 보정 */
        footer.bg-primary {
            grid-column: 1 / -1;
            margin-left: 0;
            margin-right: 0;
        }
    </style>


    <style>
        :root {
            --primary: #6B4F4F;
            --secondary: #8B7070;
            --accent: #A89080;
            --light: #E8D5D5;
        }
        .bg-primary { background-color: var(--primary); }
        .bg-secondary { background-color: var(--secondary); }
        .text-primary { color: var(--primary); }
        .border-primary { border-color: var(--primary); }
        .hover\:bg-primary:hover { background-color: var(--primary); }
        .hover\:bg-secondary:hover { background-color: var(--secondary); }
        .hover\:text-primary:hover { color: var(--primary); }
    </style>
</head>
<body class="bg-gray-50">
<div class="bg-primary text-white py-2">
    <div class="max-w-7xl mx-auto px-4">
        <div class="flex justify-end items-center space-x-6 text-sm">

            <!-- ✅ 로그인 상태 -->
            <span th:if="${#authorization.expression('isAuthenticated()')}"
                  th:text="${#authentication.name} + '님'">사용자님</span>

            <form th:if="${#authorization.expression('isAuthenticated()')}"
                  th:action="@{/users/logout}" method="post" class="inline">
                <button type="submit" class="hover:underline bg-transparent border-0 text-white">로그아웃</button>
            </form>

            <!-- ✅ 비로그인 상태 -->
            <a th:if="${#authorization.expression('isAnonymous()')}"
               href="/users/login"
               class="hover:underline">로그인</a>

            <a th:if="${#authorization.expression('isAnonymous()')}"
               href="/users/signup"
               class="hover:underline">회원가입</a>
        </div>
    </div>
</div>

<!-- Navbar -->
<nav class="bg-white shadow-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-20">
            <a href="/main" class="flex items-center space-x-3">
                <i class="bi bi-shop text-4xl text-primary"></i>
                <span class="text-3xl font-bold text-primary">GUGU Market</span>
            </a>
        </div>
    </div>
</nav>

<!-- Breadcrumb -->
<div class="bg-white border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex items-center space-x-2 text-sm text-gray-600">
            <!-- 홈 링크 -->
            <a href="/" class="hover:text-primary">
                <i class="bi bi-house-door"></i> 홈
            </a>
            <i class="bi bi-chevron-right text-xs"></i>

            <!-- 카테고리 링크 (⭐ 수정됨) -->
            <a th:if="${product.category != null}"
               th:href="@{/main(categoryId=${product.category.categoryId})}"
               class="hover:text-primary transition-colors duration-200"
               th:text="${product.category.name}">
                반려동물용품
            </a>
            <span th:unless="${product.category != null}" class="text-gray-400">미분류</span>

            <i class="bi bi-chevron-right text-xs"></i>

            <!-- 현재 상품명 -->
            <span class="text-gray-800 font-medium" th:text="${product.title}">캠핑 텐트 4인용</span>
        </div>
    </div>
</div>

<!-- Product Detail -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Left: Product Images -->
        <div class="space-y-4">
            <!-- Main Image -->
            <div class="bg-white rounded-2xl overflow-hidden shadow-lg">
                <img
                        id="mainImage"
                        th:src="${product.mainImage}"
                        th:alt="${product.title}"
                        class="w-full h-96 object-cover"
                        onerror="this.src='https://via.placeholder.com/600x400/6B4F4F/FFFFFF?text=No+Image'"
                />
            </div>

            <!-- Thumbnail Images -->
            <div class="grid grid-cols-4 gap-3" th:if="${product.productImages != null && !product.productImages.isEmpty()}">
                <div th:each="image : ${product.productImages}"
                     class="bg-white rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-primary transition-all">
                    <img
                            th:src="${image.imageUrl}"
                            th:alt="'상품 이미지 ' + ${image.imageOrder}"
                            class="w-full h-24 object-cover"
                            onclick="changeMainImage(this.src)"
                    />
                </div>
            </div>

        <!-- Right: Product Info -->
        <div class="space-y-6">
            <div class="bg-white rounded-2xl shadow-lg p-8">
                <!-- Title -->
                <h1 class="text-3xl font-bold text-gray-800 mb-4" th:text="${product.title}">상품명</h1>

                <!-- Price -->
                <div class="mb-6">
                        <span class="text-4xl font-bold text-primary">
                            <span th:text="${#numbers.formatInteger(product.price, 0, 'COMMA')}">0</span>원
                        </span>
                </div>

                <!-- Product Meta Info -->
                <div class="space-y-3 py-6 border-y border-gray-200">
                    <div class="flex justify-between">
                        <span class="text-gray-600">카테고리</span>
                        <span class="font-medium" th:text="${product.category.name}">전자기기</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">상태</span>
                        <span class="font-medium">중고</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">판매자</span>
                        <span class="font-medium" th:text="${product.seller.nickname}">판매자명</span>
                    </div>
                    <div class="flex justify-between" th:if="${product.seller.address != null}">
                        <span class="text-gray-600">거래지역</span>
                        <span class="font-medium" th:text="${product.seller.address}">서울 강남구</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">조회수</span>
                        <span class="font-medium" th:text="${product.viewCount}">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">등록일</span>
                        <span class="font-medium" th:text="${#temporals.format(product.createdDate, 'yyyy-MM-dd')}">2025-01-01</span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="mt-6">
                    <!-- 🔥 판매자인 경우 (수정됨!) -->
                    <div th:if="${#authentication.principal != null and #authentication.name == product.seller.userName}">

                        <!-- 상태 변경 UI -->
                        <div class="mb-4 p-4 bg-gray-50 rounded-lg border-2 border-gray-200">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-700 font-medium">상품 상태</span>
                                <select
                                        id="statusSelect"
                                        th:data-product-id="${product.productId}"
                                        class="border-2 border-primary rounded-lg px-4 py-2 font-medium">
                                    <option value="SALE" th:selected="${product.status.name() == 'SALE'}">🟢 판매중</option>
                                    <option value="RESERVED" th:selected="${product.status.name() == 'RESERVED'}">🟡 예약중</option>
                                    <option value="SOLD_OUT" th:selected="${product.status.name() == 'SOLD_OUT'}">🔴 판매완료</option>
                                </select>
                            </div>
                        </div>

                        <button
                                onclick="saveStatus()"
                                class="w-full bg-primary hover:bg-secondary text-white font-bold py-4 rounded-lg transition-all mb-3">
                            <i class="bi bi-check-circle text-xl mr-2"></i>상태 변경 저장
                        </button>

                        <!-- 🔥 구매 희망자 목록 -->
                        <div class="p-4 bg-blue-50 rounded-lg border-2 border-blue-200" th:if="${interestedBuyers != null}">
                            <h3 class="font-bold text-gray-800 mb-3 flex items-center justify-between">
                                    <span>
                                        <i class="bi bi-people-fill mr-2"></i>구매 희망자 목록
                                    </span>
                                <span class="text-sm text-blue-600" th:text="'총 ' + ${interestedBuyers.size()} + '명'">총 0명</span>
                            </h3>

                            <div class="space-y-2 max-h-64 overflow-y-auto" th:if="${!interestedBuyers.empty}">
                                <div th:each="buyer : ${interestedBuyers}"
                                     class="flex items-center justify-between bg-white p-3 rounded-lg hover:shadow-md transition-all">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-gradient-to-br from-primary to-secondary rounded-full flex items-center justify-center">
                                            <i class="bi bi-person text-white"></i>
                                        </div>
                                        <div>
                                            <p class="font-semibold" th:text="${buyer.nickname}">구매자명</p>
                                            <p class="text-sm text-gray-500" th:if="${buyer.address != null}">
                                                <i class="bi bi-geo-alt"></i>
                                                <span th:text="${buyer.address}">주소</span>
                                            </p>
                                        </div>
                                    </div>
                                    <form th:action="@{/product/{id}/complete(id=${product.productId})}"
                                          method="post"
                                          onsubmit="return confirm('이 사용자와 거래를 완료하시겠습니까?\n거래 완료 후에는 취소할 수 없습니다.');">
                                        <input type="hidden" name="buyerId" th:value="${buyer.userId}">
                                        <button
                                                type="submit"
                                                class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-all flex items-center gap-2"
                                                th:disabled="${product.status.name() == 'SOLD_OUT'}">
                                            <i class="bi bi-check-circle"></i>
                                            거래완료
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <div th:if="${interestedBuyers.empty}"
                                 class="text-center py-8 text-gray-500">
                                <i class="bi bi-inbox text-4xl mb-2"></i>
                                <p>아직 찜한 사용자가 없습니다.</p>
                                <p class="text-sm mt-1">상품을 찜한 사용자가 여기에 표시됩니다.</p>
                            </div>
                        </div>

                        <!-- 수정/삭제 버튼 -->
                        <div class="flex gap-3 mt-3">
                            <button
                                    th:onclick="|location.href='/product/${product.productId}/edit'|"
                                    class="flex-1 bg-white border-2 border-primary text-primary hover:bg-primary hover:text-white font-bold py-3 rounded-lg transition-all">
                                <i class="bi bi-pencil mr-1"></i>수정
                            </button>
                            <button
                                    onclick="deleteProduct()"
                                    class="flex-1 bg-white border-2 border-red-500 text-red-500 hover:bg-red-500 hover:text-white font-bold py-3 rounded-lg transition-all">
                                <i class="bi bi-trash mr-1"></i>삭제
                            </button>
                        </div>
                    </div>

                    <!-- 🔥 일반 사용자인 경우 (수정됨!) -->
                    <div th:if="${#authentication.principal == null or #authentication.name != product.seller.userName}">
                        <!-- 판매완료/예약중 표시 -->
                        <div th:if="${product.status.name() == 'SOLD_OUT'}" class="mb-4 p-4 bg-red-50 border-2 border-red-200 rounded-lg text-center">
                            <p class="text-red-700 font-bold text-lg">🔴 판매완료된 상품입니다</p>
                        </div>

                        <div th:if="${product.status.name() == 'RESERVED'}" class="mb-4 p-4 bg-yellow-50 border-2 border-yellow-200 rounded-lg text-center">
                            <p class="text-yellow-700 font-bold text-lg">🟡 예약중인 상품입니다</p>
                        </div>

                        <div class="flex gap-3">
                            <!-- 🔥 찜하기 버튼 -->
                            <button
                                    id="likeButton"
                                    onclick="toggleLike()"
                                    th:classappend="${isLiked} ? 'bg-red-500 text-white border-red-500' : 'bg-white text-primary border-primary hover:bg-primary hover:text-white'"
                                    class="flex-1 border-2 font-bold py-4 rounded-lg transition-all duration-300 flex items-center justify-center gap-2"
                                    th:disabled="${product.status.name() == 'SOLD_OUT'}">
                                <i th:class="${isLiked} ? 'bi bi-heart-fill' : 'bi bi-heart'" class="text-xl"></i>
                                <span id="likeText" th:text="${isLiked} ? '찜 취소' : '찜하기'">찜하기</span>
                                <span id="likeCount"
                                      class="ml-1 px-2 py-0.5 bg-black/10 rounded-full text-sm"
                                      th:text="${likeCount}">0</span>
                            </button>

                            <!-- 구매하기 버튼 -->
                            <button
                                    th:onclick="${product.status.name() == 'SOLD_OUT'} ? 'alert(\'판매완료된 상품입니다.\')' : 'location.href=\'/purchase?productId=' + ${product.productId} + '\''"
                                    class="flex-1 bg-primary hover:bg-secondary text-white font-bold py-4 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-lg flex items-center justify-center gap-2"
                                    th:classappend="${product.status.name() == 'SOLD_OUT'} ? 'opacity-50 cursor-not-allowed bg-gray-400 hover:bg-gray-400' : ''"
                                    th:disabled="${product.status.name() == 'SOLD_OUT'}">
                                <i class="bi bi-cart text-xl"></i>
                                <span th:text="${product.status.name() == 'SOLD_OUT'} ? '판매완료' : '구매하기'">구매하기</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Share & Report -->
                <div class="flex gap-3 mt-4">
                    <button class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 rounded-lg transition-all">
                        <i class="bi bi-share mr-2"></i>공유하기
                    </button>
                    <button class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 rounded-lg transition-all">
                        <i class="bi bi-flag mr-2"></i>신고하기
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Description -->
    <div class="mt-8 bg-white rounded-2xl shadow-lg p-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">상품 설명</h2>
        <div class="prose max-w-none text-gray-700 leading-relaxed whitespace-pre-line" th:text="${product.content}">
            상품 설명 내용이 여기에 표시됩니다.
        </div>
    </div>



        <!-- 댓글 시작 -->
        <script th:inline="javascript">
            /* CSRF 메타 자동 주입 */
            (function(){
                var token  = /*[[${_csrf.token}]]*/ '';
                var header = /*[[${_csrf.headerName}]]*/ 'X-CSRF-TOKEN';
                if (token && !document.querySelector('meta[name="_csrf"]')) {
                    var m1=document.createElement('meta'); m1.name='_csrf'; m1.content=token; document.head.appendChild(m1);
                    var m2=document.createElement('meta'); m2.name='_csrf_header'; m2.content=header; document.head.appendChild(m2);
                }
            })();

            /* 댓글 섹션 없으면 자동 생성 */
            (function ensureCommentSection(){
                const hasForm = document.querySelector('form[action$="/comment"], form[th\\:action="@{/comment}"]');
                if (hasForm) return;

                const productId = /*[[${product.productId}]]*/ 0;
                const descBlock = Array.from(document.querySelectorAll('div.mt-8.bg-white.rounded-2xl.shadow-lg.p-8'))
                    .find(box => box.querySelector('h2') && box.querySelector('h2').textContent.includes('상품 설명'));
                const mountPoint = descBlock?.parentElement || document.querySelector('.max-w-7xl.mx-auto') || document.body;

                const wrapper = document.createElement('div');
                wrapper.className = 'mt-8 bg-white rounded-2xl shadow-lg p-8';
                wrapper.innerHTML = `
<h2 class="text-2xl font-bold text-gray-800 mb-6">댓글 <span class="text-primary">0</span></h2>
<form action="/comment" method="post" class="mb-8">
  <input type="hidden" name="productId" value="${productId}" />
  <textarea name="content" rows="3"
    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-primary resize-none"
    placeholder="댓글을 입력하세요..." required></textarea>
  <div class="flex justify-end mt-3">
    <button type="submit"
      class="bg-primary hover:bg-secondary text-white font-medium px-6 py-2 rounded-lg transition-all">
      댓글 작성
    </button>
  </div>
</form>
<div class="space-y-4"></div>
`;
                if (descBlock) descBlock.insertAdjacentElement('afterend', wrapper);
                else mountPoint.appendChild(wrapper);
            })();

            /* 댓글 본체: 목록/작성/수정/삭제 + ✅대댓글(아래 '답글' 버튼) */
            (function () {
                const getMeta = (n)=>document.querySelector(`meta[name="${n}"]`)?.getAttribute('content')||'';
                const CSRF_TOKEN  = getMeta('_csrf');
                const CSRF_HEADER = getMeta('_csrf_header')||'X-CSRF-TOKEN';

                const $  = (s,r=document)=>r.querySelector(s);
                const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));

                // 폼 submit 가로채기(최상위 댓글)
                document.addEventListener('submit',(e)=>{
                    const f=e.target;
                    const action=(f.getAttribute('action')||f.getAttribute('th:action')||'')+'';
                    if(action.endsWith('/comment')){ e.preventDefault(); handleSubmit(f); }
                },true);

                const commentForm = document.querySelector('form[action$="/comment"]') ||
                    document.querySelector('form[th\\:action="@{/comment}"]');
                if(!commentForm) return;

                const productId  = (commentForm.querySelector('input[name="productId"]')||{}).value;
                const textarea   = commentForm.querySelector('textarea[name="content"]');
                const section    = commentForm.closest('div.mt-8.bg-white.rounded-2xl.shadow-lg.p-8');
                const listBox    = section ? $('.space-y-4', section) : null;
                const countEl    = section ? $('h2 span.text-primary', section) : null;

                // ✅ 스타일 (답글 버튼만 수정: 테두리 제거 + 왼쪽으로 살짝 이동)
                const style=document.createElement('style');
                style.textContent=`
.gugu-pop{position:absolute;right:0;top:28px;background:#fff;border:1px solid rgba(0,0,0,.1);
  border-radius:.5rem;box-shadow:0 10px 25px rgba(0,0,0,.08);overflow:hidden;z-index:60}
.gugu-pop button{display:block;width:120px;padding:10px 12px;text-align:left;font-size:14px}
.gugu-pop button:hover{background:rgba(0,0,0,.04)}
.gugu-item:hover .gugu-dots{color:#111827}
.gugu-edit,.gugu-reply{border:2px solid #e5e7eb;border-radius:.75rem;padding:.5rem;margin-top:.5rem;display:none}
.gugu-edit.show,.gugu-reply.show{display:block}
.gugu-children{margin-left:3rem;margin-top:.5rem}

/* ← 여기만 바뀜: 답글 버튼 위치와 모양 */
.gugu-actions{
  margin-left:0;       /* ← 들여쓰기 제거 */
  margin-top:0.25rem;  /* 약간의 위 여백만 */
}
.gugu-btn{
  display:inline-flex;align-items:center;gap:.375rem;
  border:0;background:transparent;padding:0;
  color:#6b7280;font-size:.875rem;line-height:1;cursor:pointer
}
.gugu-btn:hover{color:#374151}
`;
                document.head.appendChild(style);

                function jfetch(url,opt={}){
                    opt.headers=Object.assign({'Accept':'application/json','X-Requested-With':'XMLHttpRequest'},opt.headers||{});
                    const m=(opt.method||'GET').toUpperCase();
                    if(['POST','PUT','DELETE','PATCH'].includes(m)){
                        if(CSRF_TOKEN) opt.headers[CSRF_HEADER]=CSRF_TOKEN;
                        if(!opt.headers['Content-Type'] && !(opt.body instanceof FormData)){
                            opt.headers['Content-Type']='application/json';
                        }
                    }
                    return fetch(url,opt);
                }

                // 목록 불러오기
                async function fetchListSafe(){
                    try{
                        const res = await jfetch(`/api/products/${productId}/comments`);
                        if(!res.ok) return;
                        const data = await res.json().catch(()=>null);
                        if(!data || data.success===false || !Array.isArray(data.comments)) return;
                        renderTree(data.comments);
                        if(countEl) countEl.textContent = (data.count ?? data.comments.length);
                    }catch(err){
                        console.error('[댓글] 목록 로드 실패:',err);
                    }
                }

                // 최상위 댓글 등록
                async function handleSubmit(){
                    const content = textarea.value.trim();
                    if(!content) return alert('내용을 입력하세요.');
                    try{
                        const res = await jfetch(`/api/products/${productId}/comments`,{
                            method:'POST', body:JSON.stringify({content})
                        });
                        const data = await res.json();
                        if(data.needLogin){
                            if(confirm('로그인이 필요한 기능입니다. 로그인 페이지로 이동할까요?')) location.href='/users/login';
                            return;
                        }
                        if(!data.success) return alert(data.message||'등록 실패');
                        textarea.value='';
                        const it = createItem(data.comment);
                        listBox.appendChild(it);
                        if(countEl) countEl.textContent = (data.count ?? (parseInt(countEl.textContent||'0',10)+1));
                    }catch(err){
                        console.error('[댓글] 등록 실패:',err);
                        alert('등록 중 오류가 발생했습니다.');
                    }
                }

                const esc = s => String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

                function createItem(c){
                    const wrap=document.createElement('div');
                    wrap.className="border-b border-gray-200 pb-4 last:border-b-0 gugu-item";
                    wrap.dataset.id=c.id;

                    // 자식 컨테이너
                    const childrenWrap=document.createElement('div');
                    childrenWrap.className='gugu-children';

                    wrap.innerHTML=`
<div class="flex items-start justify-between mb-2 relative">
  <div class="flex items-center gap-3">
    <div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center">
      <i class="bi bi-person text-gray-600 text-xl"></i>
    </div>
    <div>
      <p class="font-semibold text-gray-800">${esc(c.userNickname??'사용자')}</p>
      <p class="text-sm text-gray-500">${c.createdAt??''}</p>
    </div>
  </div>

  <!-- ··· 메뉴 (수정/삭제) -->
  <button class="text-gray-400 hover:text-gray-600 gugu-dots"><i class="bi bi-three-dots-vertical"></i></button>
  <div class="gugu-pop hidden">
    ${c.mine?`
      <button data-act="edit"><i class="bi bi-pencil"></i> 수정</button>
      <button data-act="del" class="text-red-600"><i class="bi bi-trash"></i> 삭제</button>
    `:`<div class="px-3 py-2 text-sm text-gray-500 select-none">작업 없음</div>`}
  </div>
</div>

<!-- 본문 -->
<p class="text-gray-700 ml-13 whitespace-pre-line gugu-content">${esc(c.content??'')}</p>

<!-- 하단 동작영역: ✅ 항상 보이는 "답글" 버튼 (테두리 없음, 왼쪽으로 살짝) -->
<div class="gugu-actions">
  <button type="button" class="gugu-btn" data-act="reply-open">
    <i class="bi bi-reply"></i><span>답글</span>
  </button>
</div>

<!-- 수정 폼 -->
<div class="gugu-edit">
  <textarea class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 focus:outline-none focus:border-primary resize-none" rows="3">${esc(c.content??'')}</textarea>
  <div class="flex justify-end gap-2 mt-2">
    <button class="px-4 py-2 rounded-lg border-2 border-gray-300" data-edit-cancel>취소</button>
    <button class="px-4 py-2 rounded-lg bg-primary text-white" data-edit-save>수정</button>
  </div>
</div>

<!-- ✅ 답글 폼 -->
<div class="gugu-reply">
  <textarea class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 focus:outline-none focus:border-primary resize-none" rows="3" placeholder="답글을 입력하세요..."></textarea>
  <div class="flex justify-end gap-2 mt-2">
    <button class="px-4 py-2 rounded-lg border-2 border-gray-300" data-reply-cancel>취소</button>
    <button class="px-4 py-2 rounded-lg bg-primary text-white" data-reply-save>답글 등록</button>
  </div>
</div>
`;
                    wrap.appendChild(childrenWrap);

                    // 메뉴 열기/닫기
                    const dots=$('.gugu-dots',wrap), pop=$('.gugu-pop',wrap);
                    dots?.addEventListener('click',(e)=>{e.stopPropagation(); pop.classList.toggle('hidden');});
                    document.addEventListener('click',()=>pop.classList.add('hidden'));

                    // 삭제
                    $('[data-act="del"]',wrap)?.addEventListener('click',async()=>{
                        if(!confirm('이 댓글을 삭제할까요?')) return;
                        try{
                            const res=await jfetch(`/api/comments/${c.id}`,{method:'DELETE'});
                            const data=await res.json();
                            if(data.success){
                                wrap.remove();
                                if(countEl) countEl.textContent=data.count;
                            }else if(data.needLogin){
                                alert('로그인이 필요합니다.'); location.href='/users/login';
                            }else{
                                alert(data.message||'삭제 실패');
                            }
                        }catch(err){
                            console.error('[댓글] 삭제 실패:',err); alert('삭제 중 오류가 발생했습니다.');
                        }
                    });

                    // 수정
                    $('[data-act="edit"]',wrap)?.addEventListener('click',()=>$('.gugu-edit',wrap).classList.add('show'));
                    $('[data-edit-cancel]',wrap)?.addEventListener('click',()=>{
                        const box=$('.gugu-edit',wrap), ta=$('textarea',box);
                        ta.value=c.content??''; box.classList.remove('show');
                    });
                    $('[data-edit-save]',wrap)?.addEventListener('click',async()=>{
                        const box=$('.gugu-edit',wrap), ta=$('textarea',box);
                        const content=ta.value.trim(); if(!content) return alert('내용을 입력하세요.');
                        try{
                            const res=await jfetch(`/api/comments/${c.id}`,{method:'PUT',body:JSON.stringify({content})});
                            const data=await res.json();
                            if(data.success){
                                c.content=data.comment.content;
                                $('.gugu-content',wrap).textContent=c.content;
                                ta.value=c.content; box.classList.remove('show');
                            }else if(data.needLogin){
                                alert('로그인이 필요합니다.'); location.href='/users/login';
                            }else{
                                alert(data.message||'수정 실패');
                            }
                        }catch(err){
                            console.error('[댓글] 수정 실패:',err); alert('수정 중 오류가 발생했습니다.');
                        }
                    });

                    // ✅ 답글 UI
                    $('[data-act="reply-open"]',wrap)?.addEventListener('click',()=>{
                        $('.gugu-reply',wrap).classList.add('show');
                        $('.gugu-edit',wrap)?.classList.remove('show'); // 열려있던 수정폼 닫기
                    });
                    $('[data-reply-cancel]',wrap)?.addEventListener('click',()=>{
                        const box=$('.gugu-reply',wrap), ta=$('textarea',box);
                        ta.value=''; box.classList.remove('show');
                    });
                    $('[data-reply-save]',wrap)?.addEventListener('click',async()=>{
                        const box=$('.gugu-reply',wrap), ta=$('textarea',box);
                        const content=ta.value.trim(); if(!content) return alert('내용을 입력하세요.');
                        try{
                            const res=await jfetch(`/api/products/${productId}/comments`,{
                                method:'POST', body:JSON.stringify({content, parentId:String(c.id)})
                            });
                            const data=await res.json();
                            if(data.success){
                                const child=createItem(data.comment);
                                childrenWrap.appendChild(child);
                                ta.value=''; box.classList.remove('show');
                                if(countEl) countEl.textContent = (data.count ?? (parseInt(countEl.textContent||'0',10)+1));
                            }else if(data.needLogin){
                                alert('로그인이 필요합니다.'); location.href='/users/login';
                            }else{
                                alert(data.message||'등록 실패');
                            }
                        }catch(err){
                            console.error('[댓글] 답글 등록 실패:',err); alert('등록 중 오류가 발생했습니다.');
                        }
                    });

                    // 외부에서 접근할 수 있도록 참조 저장
                    wrap._childrenWrap = childrenWrap;
                    return wrap;
                }

                // 평면 → 트리 렌더링
                function renderTree(items){
                    if(!listBox) return;
                    listBox.innerHTML='';

                    if(!items.length){
                        const empty=document.createElement('div');
                        empty.className='text-center py-8 text-gray-500';
                        empty.innerHTML=`<i class="bi bi-chat-dots text-4xl mb-2"></i><p>첫 댓글을 작성해보세요!</p>`;
                        listBox.appendChild(empty); return;
                    }

                    const nodeMap=new Map();
                    items.forEach(c=>nodeMap.set(c.id, createItem(c)));
                    items.forEach(c=>{
                        const node=nodeMap.get(c.id);
                        if(c.parentId){
                            const p=nodeMap.get(c.parentId);
                            if(p && p._childrenWrap) p._childrenWrap.appendChild(node);
                            else listBox.appendChild(node);
                        }else{
                            listBox.appendChild(node);
                        }
                    });
                }

                fetchListSafe();
            })();
        </script>
        <!-- 댓글 끝 -->




        <!-- Footer -->

<footer class="bg-primary text-white mt-20 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <p>&copy; 2025 GUGU Market. All rights reserved.</p>
    </div>
</footer>



<script th:inline="javascript">
    // Change main image when clicking thumbnail
    function changeMainImage(src) {
        document.getElementById('mainImage').src = src;
    }

    // 🔥 찜하기 토글
    async function toggleLike() {
        const productId = [[${product.productId}]];

        try {
            const response = await fetch(`/product/${productId}/like`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            const result = await response.json();

            // 로그인 필요
            if (result.needLogin) {
                if (confirm('로그인이 필요한 기능입니다.\n로그인 페이지로 이동하시겠습니까?')) {
                    location.href = '/users/login';
                }
                return;
            }

            if (result.success) {
                const likeButton = document.getElementById('likeButton');
                const likeText = document.getElementById('likeText');
                const likeCount = document.getElementById('likeCount');
                const icon = likeButton.querySelector('i');

                if (result.isLiked) {
                    // 찜하기 완료
                    likeButton.classList.remove('bg-white', 'text-primary', 'border-primary');
                    likeButton.classList.add('bg-red-500', 'text-white', 'border-red-500');
                    icon.classList.remove('bi-heart');
                    icon.classList.add('bi-heart-fill');
                    likeText.textContent = '찜 취소';
                } else {
                    // 찜하기 취소
                    likeButton.classList.remove('bg-red-500', 'text-white', 'border-red-500');
                    likeButton.classList.add('bg-white', 'text-primary', 'border-primary');
                    icon.classList.remove('bi-heart-fill');
                    icon.classList.add('bi-heart');
                    likeText.textContent = '찜하기';
                }

                likeCount.textContent = result.likeCount;
            } else {
                alert(result.message);
            }

        } catch (error) {
            console.error('Error:', error);
            alert('오류가 발생했습니다.');
        }
    }

    // 🔥 상태 변경 저장
    let originalStatus = document.getElementById('statusSelect')?.value;

    async function saveStatus() {
        const selectElement = document.getElementById('statusSelect');
        const productId = selectElement.dataset.productId;
        const newStatus = selectElement.value;

        // 변경사항이 없으면
        if (newStatus === originalStatus) {
            alert('변경된 상태가 없습니다.');
            return;
        }

        const statusText = selectElement.options[selectElement.selectedIndex].text;
        if (!confirm(`상품 상태를 "${statusText}"(으)로 변경하시겠습니까?`)) {
            selectElement.value = originalStatus;
            return;
        }

        try {
            const response = await fetch(`/product/${productId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: newStatus })
            });

            const result = await response.json();

            if (result.success) {
                alert('✅ 상태가 변경되었습니다.');
                originalStatus = newStatus;
                location.reload();
            } else {
                alert('❌ ' + (result.message || '상태 변경에 실패했습니다.'));
                selectElement.value = originalStatus;
            }
        } catch (error) {
            console.error('Error:', error);
            alert('❌ 상태 변경 중 오류가 발생했습니다.');
            selectElement.value = originalStatus;
        }
    }

    // 🔥 상품 삭제
    async function deleteProduct() {
        if (!confirm('정말로 이 상품을 삭제하시겠습니까?\n삭제된 상품은 복구할 수 없습니다.')) {
            return;
        }

        const productId = document.getElementById('statusSelect').dataset.productId;

        try {
            const response = await fetch(`/product/${productId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('✅ 상품이 삭제되었습니다.');
                location.href = '/mypage';
            } else {
                alert('❌ 상품 삭제에 실패했습니다.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('❌ 상품 삭제 중 오류가 발생했습니다.');
        }
    }
</script>

</body>
</html>