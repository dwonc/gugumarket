<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>구매하기 - GUGU Market</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary: #6B4F4F;
            --secondary: #8B7070;
            --accent: #A89080;
        }
        .bg-primary { background-color: var(--primary); }
        .bg-secondary { background-color: var(--secondary); }
        .text-primary { color: var(--primary); }
        .border-primary { border-color: var(--primary); }
        .hover\:bg-primary:hover { background-color: var(--primary); }
        .hover\:bg-secondary:hover { background-color: var(--secondary); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Top Bar -->
    <div class="bg-primary text-white py-2">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-end items-center space-x-6 text-sm">
                <span th:if="${user != null}" th:text="${user.nickname}">사용자님</span>
                <a th:if="${user != null}" href="/logout" class="hover:underline">로그아웃</a>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <a href="/" class="flex items-center space-x-3">
                    <i class="bi bi-shop text-4xl text-primary"></i>
                    <span class="text-3xl font-bold text-primary">GUGU Market</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Progress Steps -->
    <div class="bg-white border-b py-8">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between">
                <div class="flex flex-col items-center flex-1">
                    <div class="w-12 h-12 bg-primary rounded-full flex items-center justify-center text-white font-bold mb-2">
                        <i class="bi bi-check-lg text-xl"></i>
                    </div>
                    <p class="text-sm font-medium text-primary">상품 선택</p>
                </div>
                <div class="flex-1 h-1 bg-primary"></div>
                <div class="flex flex-col items-center flex-1">
                    <div class="w-12 h-12 bg-primary rounded-full flex items-center justify-center text-white font-bold mb-2">
                        2
                    </div>
                    <p class="text-sm font-medium text-primary">구매 정보 입력</p>
                </div>
                <div class="flex-1 h-1 bg-gray-300"></div>
                <div class="flex flex-col items-center flex-1">
                    <div class="w-12 h-12 bg-gray-300 rounded-full flex items-center justify-center text-white font-bold mb-2">
                        3
                    </div>
                    <p class="text-sm text-gray-500">구매 완료</p>
                </div>
            </div>
        </div>
    </div>

<!-- Main Content -->
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <h1 class="text-3xl font-bold text-gray-800 mb-8">
        <i class="bi bi-cart-check text-primary mr-2"></i>
        구매하기
    </h1>

    <!-- 🔥 여기서 폼 시작 -->
    <form th:action="@{/purchase}" th:object="${purchaseDto}" method="post" id="purchaseForm">
        <input type="hidden" name="productId" th:value="${product.productId}" />

        <!-- Product Info -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">상품 정보</h2>
            <div class="flex gap-4">
                <img
                        th:src="${product.mainImage}"
                        th:alt="${product.title}"
                        class="w-32 h-32 object-cover rounded-lg"
                        onerror="this.src='https://via.placeholder.com/150/6B4F4F/FFFFFF?text=No+Image'"
                />
                <div class="flex-1">
                    <h3 class="text-lg font-bold text-gray-800 mb-2" th:text="${product.title}">상품명</h3>
                    <p class="text-gray-600 mb-1">
                        <i class="bi bi-person-circle mr-1"></i>
                        판매자: <span th:text="${product.seller.nickname}">판매자명</span>
                    </p>
                    <p class="text-gray-600 mb-2">
                        <i class="bi bi-geo-alt mr-1"></i>
                        거래지역: <span th:text="${product.seller.address}">서울 강남구</span>
                    </p>
                    <p class="text-3xl font-bold text-primary">
                        <span th:text="${#numbers.formatInteger(product.price, 0, 'COMMA')}">0</span>원
                    </p>
                </div>
            </div>
        </div>

        <!-- Buyer Info -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">구매자 정보</h2>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">구매자명</label>
                    <input
                            type="text"
                            th:value="${user.nickname}"
                            readonly
                            class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg cursor-not-allowed"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">전화번호</label>
                    <input
                            type="text"
                            th:value="${user.phone}"
                            readonly
                            class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg cursor-not-allowed"
                    />
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">거래 희망 장소</label>
                <input
                        type="text"
                        th:value="${user.address}"
                        readonly
                        class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg mb-2 cursor-not-allowed"
                />
                <p class="text-sm text-gray-500">
                    <i class="bi bi-info-circle mr-1"></i>
                    주소 변경은 마이페이지에서 가능합니다.
                </p>
            </div>
        </div>

        <!-- Payment Method -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">결제 방법</h2>

            <!-- Payment Option -->
            <div class="border-2 border-primary bg-primary/5 rounded-lg p-4 mb-4">
                <div class="flex items-center gap-3">
                    <input
                            type="radio"
                            id="bank-transfer"
                            name="paymentMethod"
                            value="bank-transfer"
                            checked
                            class="w-5 h-5 text-primary focus:ring-primary"
                    />
                    <label for="bank-transfer" class="flex items-center gap-2 font-semibold text-gray-800 cursor-pointer">
                        <i class="bi bi-bank text-primary text-2xl"></i>
                        무통장 입금
                    </label>
                </div>
            </div>

            <!-- Bank Account Info -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="bi bi-credit-card-2-front text-blue-600"></i>
                    입금 계좌 안내
                </h3>
                <div class="space-y-3 mb-4">
                    <div class="flex justify-between items-center bg-white p-3 rounded-lg">
                        <span class="text-gray-600">은행</span>
                        <span class="font-bold text-gray-800" th:text="${product.bankName}">국민은행</span>
                    </div>
                    <div class="flex justify-between items-center bg-white p-3 rounded-lg">
                        <span class="text-gray-600">계좌번호</span>
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-gray-800" id="accountNumber" th:text="${product.accountNumber}">123-456-7890</span>
                            <button
                                    type="button"
                                    onclick="copyAccount()"
                                    class="text-primary hover:text-secondary transition-colors"
                                    title="복사"
                            >
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex justify-between items-center bg-white p-3 rounded-lg">
                        <span class="text-gray-600">예금주</span>
                        <span class="font-bold text-gray-800" th:text="${product.accountHolder}">판매자명</span>
                    </div>
                    <div class="flex justify-between items-center bg-white p-3 rounded-lg">
                        <span class="text-gray-600">입금액</span>
                        <span class="font-bold text-primary text-xl">
                            <span th:text="${#numbers.formatInteger(product.price, 0, 'COMMA')}">0</span>원
                        </span>
                    </div>
                </div>

                <!-- 🔥 입금자명 입력 -->
                <div>
                    <label for="depositorName" class="block text-sm font-medium text-gray-700 mb-2">
                        입금자명 <span class="text-red-500">*</span>
                    </label>
                    <input
                            type="text"
                            id="depositorName"
                            name="depositorName"
                            th:value="${user.nickname}"
                            required
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-primary transition-colors"
                            placeholder="입금자명을 입력하세요"
                    />
                    <p class="mt-2 text-sm text-gray-600">
                        <i class="bi bi-exclamation-circle mr-1"></i>
                        입금자명과 구매자명이 다른 경우 반드시 입력해주세요.
                    </p>
                </div>
            </div>

            <!-- Payment Notice -->
            <div class="mt-4 bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
                <div class="flex">
                    <i class="bi bi-exclamation-triangle-fill text-yellow-500 text-xl mr-3 flex-shrink-0"></i>
                    <div class="text-sm text-yellow-800">
                        <p class="font-semibold mb-1">입금 안내</p>
                        <ul class="list-disc list-inside space-y-1">
                            <li>입금 확인까지 <strong>1-2시간</strong> 정도 소요될 수 있습니다.</li>
                            <li>입금 후 <strong>24시간 이내</strong> 판매자가 확인합니다.</li>
                            <li>입금 기한 내에 입금하지 않으면 주문이 자동 취소됩니다.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Final Amount -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">결제 금액</h2>
            <div class="space-y-3">
                <div class="flex justify-between text-gray-700">
                    <span>상품 금액</span>
                    <span class="font-medium">
                        <span th:text="${#numbers.formatInteger(product.price, 0, 'COMMA')}">0</span>원
                    </span>
                </div>
                <div class="flex justify-between text-gray-700">
                    <span>배송비</span>
                    <span class="font-medium text-green-600">무료 (직거래)</span>
                </div>
                <div class="border-t-2 border-gray-200 pt-3 flex justify-between items-center">
                    <span class="text-xl font-bold text-gray-800">최종 결제 금액</span>
                    <span class="text-3xl font-bold text-primary">
                        <span th:text="${#numbers.formatInteger(product.price, 0, 'COMMA')}">0</span>원
                    </span>
                </div>
            </div>
        </div>

        <!-- Agreement -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <div class="space-y-3">
                <div class="flex items-start">
                    <input
                            id="agree-all"
                            type="checkbox"
                            class="h-5 w-5 mt-0.5 text-primary border-gray-300 rounded focus:ring-primary"
                            onchange="toggleAllAgreements(this)"
                    />
                    <label for="agree-all" class="ml-3 block text-sm font-bold text-gray-800 cursor-pointer">
                        전체 동의
                    </label>
                </div>
                <div class="border-t border-gray-200 pt-3 space-y-2">
                    <div class="flex items-start ml-4">
                        <input
                                id="agree-purchase"
                                name="agreePurchase"
                                type="checkbox"
                                required
                                class="h-4 w-4 mt-0.5 text-primary border-gray-300 rounded agreement-checkbox focus:ring-primary"
                        />
                        <label for="agree-purchase" class="ml-2 block text-sm text-gray-700 cursor-pointer">
                            구매 조건 확인 및 결제 진행에 동의합니다. <span class="text-red-500">(필수)</span>
                        </label>
                    </div>
                    <div class="flex items-start ml-4">
                        <input
                                id="agree-info"
                                name="agreeInfo"
                                type="checkbox"
                                required
                                class="h-4 w-4 mt-0.5 text-primary border-gray-300 rounded agreement-checkbox focus:ring-primary"
                        />
                        <label for="agree-info" class="ml-2 block text-sm text-gray-700 cursor-pointer">
                            개인정보 제3자 제공에 동의합니다. <span class="text-red-500">(필수)</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-4">
            <button
                    type="button"
                    onclick="history.back()"
                    class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-4 rounded-lg transition-all"
            >
                <i class="bi bi-arrow-left mr-2"></i>이전으로
            </button>
            <button
                    type="button"
                    onclick="submitPurchase()"
                    class="flex-1 bg-primary hover:bg-secondary text-white font-bold py-4 rounded-lg transition-all transform hover:scale-105 shadow-lg hover:shadow-xl"
            >
                <i class="bi bi-check-circle mr-2"></i>구매하기
            </button>
        </div>
    </form>
    <!-- 🔥 여기서 폼 끝 -->
</div>

    <!-- Footer -->
    <footer class="bg-primary text-white mt-20 py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p>&copy; 2025 GUGU Market. All rights reserved.</p>
        </div>
    </footer>

<script>
    // Copy account number
    function copyAccount() {
        const accountNumber = document.getElementById('accountNumber').textContent;
        navigator.clipboard.writeText(accountNumber).then(() => {
            alert('계좌번호가 복사되었습니다.');
        }).catch(() => {
            alert('복사에 실패했습니다.');
        });
    }

    // Toggle all agreements
    function toggleAllAgreements(checkbox) {
        const checkboxes = document.querySelectorAll('.agreement-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = checkbox.checked;
        });
    }

    // Submit purchase
    function submitPurchase() {
        const agreePurchase = document.getElementById('agree-purchase').checked;
        const agreeInfo = document.getElementById('agree-info').checked;
        const depositorName = document.getElementById('depositorName').value.trim();

        if (!agreePurchase || !agreeInfo) {
            alert('필수 약관에 동의해주세요.');
            return;
        }

        if (!depositorName) {
            alert('입금자명을 입력해주세요.');
            document.getElementById('depositorName').focus();
            return;
        }

        if (confirm('구매를 진행하시겠습니까?\n\n입금 정보를 확인하신 후 입금해주세요.')) {
            // 폼 제출
            document.getElementById('purchaseForm').submit();
        }
    }

    // Individual checkbox change
    document.querySelectorAll('.agreement-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const allChecked = Array.from(document.querySelectorAll('.agreement-checkbox'))
                .every(cb => cb.checked);
            document.getElementById('agree-all').checked = allChecked;
        });
    });
</script>

</body>
</html>